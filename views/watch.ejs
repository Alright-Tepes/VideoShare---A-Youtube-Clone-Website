<%- include('partials/header') %>

    <div class="container watch-container">
        <div class="main-content">
            <div class="video-player-wrapper">
                <iframe src="<%= video.embedUrl %>" allowfullscreen></iframe>
            </div>

            <div class="video-details">
                <h1>
                    <%= video.title %>
                </h1>

                <div class="video-actions">
                    <div class="video-meta">
                        <p>
                            <%= video.views %> izlenme • <%= new Date(video.createdAt).toLocaleDateString() %>
                        </p>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="action-btn" onclick="toggleLike('<%= video._id %>')" id="likeBtn">
                            <i class="fas fa-thumbs-up"
                                style="<%= user && video.likes.includes(user._id) ? 'color: var(--primary-color)' : '' %>"></i>
                            <span id="likeCount">
                                <%= video.likes.length %>
                            </span>
                        </button>
                        <button class="action-btn" onclick="toggleDislike('<%= video._id %>')" id="dislikeBtn">
                            <i class="fas fa-thumbs-down"
                                style="<%= user && video.dislikes.includes(user._id) ? 'color: var(--primary-color)' : '' %>"></i>
                            <span id="dislikeCount">
                                <%= video.dislikes.length %>
                            </span>
                        </button>
                        <button class="action-btn" onclick="openPlaylistModal()">
                            <i class="fas fa-plus-square"></i> Kaydet
                        </button>
                        <button class="action-btn" onclick="openReportModal('<%= video._id %>', 'video')">
                            <i class="fas fa-flag"></i> Bildir
                        </button>
                    </div>
                </div>

                <div class="description" style="background: #f2f2f2; padding: 1rem; border-radius: 8px;">
                    <p><strong>Yükleyen: <a href="/channel/<%= video.uploadedBy._id %>"
                                style="color: var(--text-color);">
                                <%= video.uploadedBy.username %>
                            </a></strong></p>
                    <p style="margin-top: 0.5rem; white-space: pre-wrap;">
                        <%= video.description %>
                    </p>
                </div>

                <div class="comments-section">
                    <h3>
                        <%= video.comments.length %> Yorum
                    </h3>

                    <% if (user) { %>
                        <form id="commentForm" onsubmit="postComment(event, '<%= video._id %>')"
                            style="margin-bottom: 2rem; display: flex; gap: 1rem;">
                            <img src="<%= user.avatarUrl %>" alt="Avatar" class="avatar">
                            <div style="flex: 1;">
                                <input type="text" id="commentText" name="text"
                                    placeholder="Herkese açık bir yorum ekleyin..." required
                                    style="width: 100%; padding: 0.5rem; border: none; border-bottom: 1px solid var(--border-color); background: transparent; color: var(--text-color); outline: none;">
                                <div style="text-align: right; margin-top: 0.5rem;">
                                    <button type="submit" class="btn btn-primary">Yorum Yap</button>
                                </div>
                            </div>
                        </form>
                        <% } else { %>
                            <p style="margin-bottom: 2rem;"><a href="/login">Giriş yapın</a> ve yorum ekleyin.</p>
                            <% } %>

                                <% video.comments.forEach(comment=> { %>
                                    <div class="comment">
                                        <a href="/channel/<%= comment.user ? comment.user._id : '#' %>">
                                            <img src="<%= comment.user ? comment.user.avatarUrl : 'https://ui-avatars.com/api/?background=random' %>"
                                                alt="Avatar" class="comment-avatar">
                                        </a>
                                        <div class="comment-body">
                                            <div class="comment-header">
                                                <a href="/channel/<%= comment.user ? comment.user._id : '#' %>"
                                                    class="comment-author"
                                                    style="color: var(--text-color); font-weight: bold; text-decoration: none;">
                                                    <%= comment.user ? comment.user.username : 'Deleted User' %>
                                                </a>
                                                <span class="comment-date">
                                                    <%= new Date(comment.date).toLocaleDateString() %>
                                                </span>
                                            </div>
                                            <p style="margin-bottom: 0.5rem;">
                                                <%= comment.text %>
                                            </p>

                                            <div class="comment-actions">
                                                <button class="btn"
                                                    style="background: none; padding: 0; color: #aaa; font-size: 0.8rem;"
                                                    onclick="showReplyForm('<%= comment._id %>')">Yanıtla</button>

                                                <% if (user && (user._id.toString()===video.uploadedBy._id.toString() ||
                                                    user._id.toString()===(comment.user ? comment.user._id.toString()
                                                    : '' ) || user.isAdmin)) { %>
                                                    <button class="btn text-danger"
                                                        style="background: none; padding: 0; font-size: 0.8rem; margin-left: 1rem;"
                                                        onclick="deleteComment('<%= video._id %>', '<%= comment._id %>')">Sil</button>
                                                    <% } %>

                                                        <button class="btn"
                                                            style="background: none; padding: 0; color: #aaa; font-size: 0.8rem; margin-left: 1rem;"
                                                            onclick="openReportModal('<%= comment._id %>', 'comment')">
                                                            <i class="fas fa-flag"></i> Bildir
                                                        </button>
                                            </div>

                                            <% if (user) { %>
                                                <form id="replyForm-<%= comment._id %>"
                                                    onsubmit="postReply(event, '<%= video._id %>', '<%= comment._id %>')"
                                                    style="display: none; margin-top: 0.5rem;">
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <img src="<%= user.avatarUrl %>" alt="Avatar"
                                                            style="width: 24px; height: 24px; border-radius: 50%;">
                                                        <input type="text" id="replyText-<%= comment._id %>"
                                                            placeholder="Yanıt ekleyin..." required
                                                            style="flex: 1; border: none; border-bottom: 1px solid var(--border-color); background: transparent; color: var(--text-color); outline: none;">
                                                    </div>
                                                    <div style="text-align: right; margin-top: 0.25rem;">
                                                        <button type="button" class="btn"
                                                            onclick="hideReplyForm('<%= comment._id %>')"
                                                            style="background: none; color: var(--text-color);">İptal</button>
                                                        <button type="submit" class="btn btn-primary"
                                                            style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">Yanıtla</button>
                                                    </div>
                                                </form>
                                                <% } %>

                                                    
                                                    <% if (comment.replies && comment.replies.length> 0) { %>
                                                        <div class="replies"
                                                            style="margin-top: 1rem; margin-left: 1rem;">
                                                            <% comment.replies.forEach(reply=> { %>
                                                                <div class="comment" style="margin-bottom: 0.5rem;">
                                                                    <a
                                                                        href="/channel/<%= reply.user ? reply.user._id : '#' %>">
                                                                        <img src="https://ui-avatars.com/api/?background=random&name=<%= typeof reply.user === 'object' ? 'U' : 'U' %>"
                                                                            alt="Avatar" class="comment-avatar"
                                                                            style="width: 24px; height: 24px;">
                                                                        
                                                                    </a>
                                                                    <div class="comment-body">
                                                                        <div class="comment-header">
                                                                            <span class="comment-author"
                                                                                style="font-size: 0.9rem; font-weight: bold;">
                                                                                <%= typeof reply.user==='object'
                                                                                    ? 'User' : 'User' %>
                                                                            </span>
                                                                            
                                                                            <span class="comment-date"
                                                                                style="font-size: 0.8rem;">
                                                                                <%= new
                                                                                    Date(reply.date).toLocaleDateString()
                                                                                    %>
                                                                            </span>
                                                                        </div>
                                                                        <div
                                                                            style="display: flex; justify-content: space-between; align-items: flex-start;">
                                                                            <p style="font-size: 0.9rem;">
                                                                                <%= reply.text %>
                                                                            </p>
                                                                            <% if (user &&
                                                                                (user._id.toString()===video.uploadedBy._id.toString()
                                                                                || user._id.toString()===(reply.user ?
                                                                                reply.user._id.toString() : '' ) ||
                                                                                user.isAdmin)) { %>
                                                                                <button class="btn text-danger"
                                                                                    style="background: none; padding: 0; font-size: 0.7rem;"
                                                                                    onclick="deleteComment('<%= video._id %>', '<%= reply._id %>')">Delete</button>
                                                                                <% } %>
                                                                                    <button class="btn"
                                                                                        style="background: none; padding: 0; color: #aaa; font-size: 0.7rem; margin-left: 0.5rem;"
                                                                                        onclick="openReportModal('<%= reply._id %>', 'comment')">
                                                                                        <i class="fas fa-flag"></i>
                                                                                    </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <% }) %>
                                                        </div>
                                                        <% } %>
                                        </div>
                                    </div>
                                    <% }) %>
                </div>
            </div>
        </div>
    </div>
    <script src="/js/video-interactions.js"></script>
    </div>
    </div>
    </div>

    
    </div>

    
    <% if (user) { %>
        <div id="playlistModal" class="modal"
            style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content"
                style="background-color: var(--surface-color); margin: 15% auto; padding: 2rem; border: 1px solid var(--border-color); width: 100%; max-width: 400px; border-radius: 8px;">
                <span onclick="document.getElementById('playlistModal').style.display='none'"
                    style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                <h3 style="margin-bottom: 1rem;">Oynatma listesine kaydet</h3>
                <div id="playlistList">
                    <p>Yükleniyor...</p>
                </div>
                <hr style="margin: 1rem 0;">
                <form id="createPlaylistForm" onsubmit="createPlaylistAndAdd(event)">
                    <div class="form-group">
                        <label>Yeni oynatma listesi oluştur</label>
                        <input type="text" id="newPlaylistTitle" placeholder="Başlık girin..." required
                            style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Oluştur ve Kaydet</button>
                </form>
            </div>
        </div>

        <script>
            const currentVideoId = '<%= video._id %>';

            function openPlaylistModal() {
                document.getElementById('playlistModal').style.display = 'block';
                fetchPlaylists();
            }

            async function fetchPlaylists() {
                const list = document.getElementById('playlistList');
                try {
                    // We reuse getMyPlaylists but ideally should have an API that returns JSON
                    // For now, let's assume we implement a JSON endpoint or parse.
                    // Actually, let's create a quick API endpoint for this in apiController
                    const response = await fetch('/api/playlists');
                    const playlists = await response.json();

                    if (playlists.length === 0) {
                        list.innerHTML = '<p>No playlists found.</p>';
                        return;
                    }

                    list.innerHTML = playlists.map(pl => `
                    <div style="padding: 0.5rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);">
                        <span>${pl.title}</span>
                        <input type="checkbox" ${pl.videos.includes(currentVideoId) ? 'checked' : ''} 
                               onchange="togglePlaylist('${pl._id}', this.checked)">
                    </div>
                `).join('');
                } catch (e) {
                    list.innerHTML = '<p>Error loading playlists.</p>';
                }
            }

            async function togglePlaylist(playlistId, checked) {
                const url = checked ? '/playlist/add' : `/playlist/${playlistId}/remove`; // Remove needs update to support videoId body
                // Simplify: Just support ADD for now in this iteration or fix api

                if (checked) {
                    await fetch('/playlist/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ playlistId, videoId: currentVideoId })
                    });
                } else {
                    // Implement remove logic if needed via API
                    alert('Removing from playlist not fully implemented in valid JSON API yet, please manage from Playlist page.');
                }
            }

            async function createPlaylistAndAdd(e) {
                e.preventDefault();
                const title = document.getElementById('newPlaylistTitle').value;
                // Call API to create and then add
                // For simplicity, just submit form to standard route? No, we want to stay on page.
                // Let's rely on standard form submission for creation if we didn't make an API
                alert('Please create playlist from the Playlists page first!');
            }

            // Close modal
            window.onclick = function (event) {
                if (event.target == document.getElementById('playlistModal')) {
                    document.getElementById('playlistModal').style.display = "none";
                }
            }
        </script>
        <% } %>

            <div id="reportModal" class="modal"
                style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
                <div class="modal-content"
                    style="background-color: var(--surface-color); margin: 15% auto; padding: 2rem; border: 1px solid var(--border-color); width: 100%; max-width: 400px; border-radius: 8px;">
                    <span onclick="document.getElementById('reportModal').style.display='none'"
                        style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                    <h3 style="margin-bottom: 1rem;">İçeriği Bildir</h3>
                    <form id="reportForm" onsubmit="submitReport(event)">
                        <input type="hidden" id="reportItemId">
                        <input type="hidden" id="reportItemType">
                        <div class="form-group">
                            <label>Neden</label>
                            <select id="reportReason" required
                                style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                                <option value="Inappropriate">Uygunsuz içerik</option>
                                <option value="Spam">Spam/Yanıltıcı</option>
                                <option value="Hate Speech">Nefret Söylemi</option>
                                <option value="Harassment">Taciz</option>
                                <option value="Copyright">Telif Hakkı İhlali</option>
                                <option value="Other">Diğer</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Bildirimi Gönder</button>
                    </form>
                </div>
            </div>

            <script>
                function openReportModal(itemId, itemType) {
                    if (!'<%= user ? user._id : "" %>') {
                        window.location.href = '/login';
                        return;
                    }
                    document.getElementById('reportItemId').value = itemId;
                    document.getElementById('reportItemType').value = itemType;
                    document.getElementById('reportModal').style.display = 'block';
                }

                async function submitReport(e) {
                    e.preventDefault();
                    const itemId = document.getElementById('reportItemId').value;
                    const itemType = document.getElementById('reportItemType').value;
                    const reason = document.getElementById('reportReason').value;

                    const response = await fetch('/api/report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ itemId, itemType, reason })
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert('Bildiriminiz için teşekkürler. Yöneticilerimiz inceleyecektir.');
                        document.getElementById('reportModal').style.display = 'none';
                    } else {
                        alert('Bildirim gönderilirken hata oluştu.');
                    }
                }
            </script>

            <%- include('partials/footer') %>